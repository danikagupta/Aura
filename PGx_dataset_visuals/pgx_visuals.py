# -*- coding: utf-8 -*-
"""pgx_visuals.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xTGINITmO5JlMjoDlQXoAjISa2S2E-Gb
"""

from google.colab import drive
drive.mount('/content/drive')

import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
import re

# ==========================================
# CONFIGURATION
# ==========================================
GPT_FILE = '/content/drive/Shareddrives/Danika-work5/LLM_Extract/Davidson/pgx_GPT_standardized_data.csv'
GEMINI_FILE = '/content/drive/Shareddrives/Danika-work5/LLM_Extract/Davidson/pgx_gemini_standardized_datacsv'

def clean_phenotype(text):
    if pd.isna(text): return "Unspecified"
    text = str(text).lower()
    # Remove metadata and standard suffixes
    text = re.sub(r'\(.*?\)', '', text)
    text = re.sub(r'inferred phenotype:|not reported:|phenotype:', '', text)
    text = text.replace('metabolizer', '').strip()
    # Clean up abbreviations
    text = text.replace('im', '').replace('pm', '').replace('nm', '').replace('um', '').strip()
    text = text.title()
    # Standardize common mappings
    mapping = {'Extensive': 'Normal', 'Rapid Or Ultrarapid': 'Ultrarapid/Rapid'}
    return mapping.get(text, text)

def generate_comparative_richness():
    # 1. LOAD DATA
    print("Loading datasets...")
    df_gpt = pd.read_csv(GPT_FILE)
    df_gemini = pd.read_csv(GEMINI_FILE)

    # 2. PREPROCESS
    df_gpt['Source'] = 'GPT-4o'
    df_gemini['Source'] = 'Gemini'

    combined = pd.concat([df_gpt, df_gemini], axis=0, ignore_index=True)
    combined['clean_pheno'] = combined['phenotype_description'].apply(clean_phenotype)
    combined['outcome_len'] = combined['outcome'].str.len().fillna(0)
    combined['medication'] = combined['medication'].str.title().fillna('Unknown')
    combined['gene'] = combined['gene'].str.upper().fillna('Unknown')

    # 3. SETUP VISUALS (2x2 Grid)
    fig, axes = plt.subplots(2, 2, figsize=(20, 16))
    sns.set_style("whitegrid")

    # --- Plot 1: Clinical Phenotype Diversity (Grouped) ---
    top_phenos = ['Normal', 'Intermediate', 'Poor', 'Rapid', 'Ultrarapid']
    pheno_data = combined[combined['clean_pheno'].isin(top_phenos)]
    sns.countplot(data=pheno_data, y='clean_pheno', hue='Source', ax=axes[0,0],
                  palette='viridis', order=top_phenos)
    axes[0,0].set_title('1. Clinical Phenotype Diversity (Functional Variety)', fontsize=15)
    axes[0,0].set_ylabel('Phenotype (Suffixes Removed)')
    axes[0,0].set_xlabel('Number of Extractions')

    # --- Plot 2: Lexical Density (Informativeness) ---
    sns.kdeplot(data=combined, x='outcome_len', hue='Source', fill=True, ax=axes[0,1], common_norm=False)
    axes[0,1].set_title('2. Lexical Density (Depth of Outcome Descriptions)', fontsize=15)
    axes[0,1].set_xlabel('Outcome String Character Count')
    axes[0,1].set_ylabel('Density')

    # --- Plot 3: Top Medications (Discovery Breadth) ---
    top_15_meds = combined['medication'].value_counts().nlargest(15).index
    med_data = combined[combined['medication'].isin(top_15_meds)]
    sns.countplot(data=med_data, y='medication', hue='Source', ax=axes[1,0],
                  palette='magma', order=top_15_meds)
    axes[1,0].set_title('3. Top 15 Medications (Breadth of Pharmacopeia)', fontsize=15)
    axes[1,0].set_ylabel('Medication Name')
    axes[1,0].set_xlabel('Extraction Count')

    # --- Plot 4: Top Genes (Knowledge Hotspots) ---
    top_15_genes = combined['gene'].value_counts().nlargest(15).index
    gene_data = combined[combined['gene'].isin(top_15_genes)]
    sns.countplot(data=gene_data, y='gene', hue='Source', ax=axes[1,1],
                  palette='rocket', order=top_15_genes)
    axes[1,1].set_title('4. Top 15 Genes (Genetic Coverage Focus)', fontsize=15)
    axes[1,1].set_ylabel('Gene Symbol')
    axes[1,1].set_xlabel('Extraction Count')

    plt.tight_layout(pad=5.0)
    plt.savefig('pgx_comparative_richness.png', dpi=300)
    print("Visuals generated successfully! Check 'pgx_comparative_richness.png'.")

# Execute
generate_comparative_richness()